---
version: 2.1

parameters:
  python-version:
    type: string
    default: "3.11"
  publish-branch:
    type: string
    default: "main"
  python-module:
    type: string
    default: "api_tabular"
  api-port:
    type: string
    default: "8005"
  docker-registry-url:
    type: string
    default: "registry.gitlab.com/etalab/data.gouv.fr/infra"
  docker-image-name-tabular:
    type: string
    default: "tabular-api"
  docker-image-name-metrics:
    type: string
    default: "metrics-api"

jobs:
  lint:
    docker:
      - image: ghcr.io/astral-sh/uv:python<< pipeline.parameters.python-version >>-trixie
    steps:
      - checkout
      - run:
          name: Install Python dependencies
          command: uv sync --frozen
      - run:
          name: Lint and format code and sort imports
          # ruff check --select I . : check linting and imports sorting without fixing (to fix, use --fix)
          # ruff format --check . : check code formatting without fixing (to fix, remove --check)
          command: |
            uv run ruff check --select I .
            uv run ruff format --check .
      - run:
          name: Type check
          command: uv run ty check

  tests:
    machine:
      image: ubuntu-2404:current  # Machine executor needed to run Docker containers (PostgreSQL + PostgREST)
    steps:
      - checkout
      - run:
          name: Start test containers
          command: |
            docker compose --profile test up -d
      - run:
          name: Wait for PostgreSQL to be ready
          command: |
            # Wait for PostgreSQL to be ready to accept connections
            timeout 60 bash -c 'until docker compose exec -T postgres-test pg_isready -U csvapi; do sleep 2; done'
      - run:
          name: Wait for PostgREST to be ready
          command: |
            # Wait for PostgREST to be ready
            timeout 30 bash -c 'until curl -f http://localhost:8080/ > /dev/null 2>&1; do sleep 2; done'
      - run:
          name: Install uv and dependencies and dev dependencies
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.local/bin:$PATH"
            uv python install << pipeline.parameters.python-version >>
            uv sync --frozen
      - run:
          name: Run tests
          command: |
            export PATH="$HOME/.local/bin:$PATH"
            uv run pytest --junitxml=reports/python/tests.xml -p no:sugar --color=yes
      - store_test_results:
          path: reports/python

  build:
    machine:
      image: ubuntu-2404:current
    steps:
      - checkout
      - run:
          name: Install uv and Python << pipeline.parameters.python-version >>
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.local/bin:$PATH"
            uv python install << pipeline.parameters.python-version >>
            uv sync --frozen
      - run:
          name: Compute RELEASE_VERSION via setuptools_scm, and build wheel
          command: |
            export PATH="$HOME/.local/bin:$PATH"
            uv pip install --system setuptools-scm
            # derive from setuptools_scm or base version + build number
            RELEASE_VERSION=$(python -m setuptools_scm)
            echo "Building a wheel release with version $RELEASE_VERSION"
            echo "Build number: $CIRCLE_BUILD_NUM"
            echo "Commit hash: ${CIRCLE_SHA1:0:7}"
            echo "Git tag: $CIRCLE_TAG"
            echo "RELEASE_VERSION=$RELEASE_VERSION" >> "$BASH_ENV"
            uv build --wheel
      - store_artifacts:
          path: dist
      - persist_to_workspace:
          root: .
          paths:
            - .
      - run:
          name: Log in to Docker registry
          command: |
            echo "${DOCKER_REGISTRY_PASSWORD}" | docker login -u "oauth2" --password-stdin registry.gitlab.com
      - run:
          name: Build and push Docker images (Tabular API and Metrics API)
          command: |
            source "$BASH_ENV"
            export PATH="$HOME/.local/bin:$PATH"
            REGISTRY="<< pipeline.parameters.docker-registry-url >>"
            # Docker tags allow only [a-zA-Z0-9_.-]; setuptools_scm can output e.g. 0.4.0.dev5+gabc1234
            DOCKER_TAG=$(echo "$RELEASE_VERSION" | tr '+' '-')
            # Tabular API: tabular endpoints only
            docker build --build-arg APP_MODULE=api_tabular.tabular.app:app_factory -t "${REGISTRY}/<< pipeline.parameters.docker-image-name-tabular >>:${DOCKER_TAG}" .
            docker push "${REGISTRY}/<< pipeline.parameters.docker-image-name-tabular >>:${DOCKER_TAG}"
            # Metrics API: metrics endpoints only
            docker build --build-arg APP_MODULE=api_tabular.metrics.app:app_factory -t "${REGISTRY}/<< pipeline.parameters.docker-image-name-metrics >>:${DOCKER_TAG}" .
            docker push "${REGISTRY}/<< pipeline.parameters.docker-image-name-metrics >>:${DOCKER_TAG}"

  publish-pypi:
    docker:
      - image: ghcr.io/astral-sh/uv:python<< pipeline.parameters.python-version >>-trixie-slim
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Publish on PyPI
          command: |
            uv publish --username "${PYPI_USERNAME}" --password "${PYPI_PASSWORD}"

workflows:
  build-test-deploy:
    jobs:
      - lint
      - tests
      - build:
          requires:
            - lint
            - tests
          filters:
            branches:
              only: << pipeline.parameters.publish-branch >>
          context: org-global
      - publish-pypi:
          requires:
            - build
          filters:
            branches:
              only: << pipeline.parameters.publish-branch >>
          context: org-global
