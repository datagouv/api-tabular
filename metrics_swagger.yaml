openapi: 3.0.3
info:
  title: data.gouv.fr Metrics API
  description: |
    Access data.gouv.fr metrics (number of downloads and/or visits per resource, organization, site, etc) as JSON or CSV.
    Supports pagination and filtering. Use query params like `column__exact=value`,
    `column__sort=asc`, `page` and `page_size`.
  version: 1.0.0
tags:
  - name: Metrics data retrieval
    description: Retrieve metrics data
  - name: Health
    description: Service health
paths:
  /api/{model}/data/:
    get:
      tags:
        - Metrics data retrieval
      description: Returns paginated metrics for the given model. Filter with `column__exact=value`, sort with `column__sort=asc` or `column__sort=desc`.
      summary: Get metrics by model (JSON)
      operationId: getMetricsByModel
      responses:
        '200':
          description: successful operation (body has data, links.next/prev, meta.page/page_size/total)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: {}
                  links:
                    type: object
                  meta:
                    type: object
        '400':
          description: Invalid query string
        '404':
          description: Model not found
    parameters:
    - name: model
      in: path
      description: Metrics table name (e.g. site, organization, dataset)
      required: true
      schema:
        type: string
        example: site
    - name: page
      in: query
      required: false
      description: Page number (1-based)
      schema:
        type: integer
        default: 1
    - name: page_size
      in: query
      required: false
      description: Number of results per page
      schema:
        type: integer
    - name: column__sort
      in: query
      required: false
      description: Sort by column (column__sort=asc or column__sort=desc)
      schema:
        type: string
        enum: [asc, desc]
    - name: column__exact
      in: query
      required: false
      description: Exact match on column (column__exact=value)
      schema:
        type: string
    - name: column__contains
      in: query
      required: false
      description: Substring match (column__contains=value)
      schema:
        type: string
    - name: column__less
      in: query
      required: false
      description: Less than (column__less=value)
      schema:
        type: string
    - name: column__greater
      in: query
      required: false
      description: Greater than (column__greater=value)
      schema:
        type: string
  /api/{model}/data/csv/:
    get:
      tags:
        - Metrics data retrieval
      description: Returns CSV for the model. Filter/sort params (column__exact, column__sort, etc.) apply; pagination is not applied (full result set is streamed).
      summary: Get metrics by model (CSV)
      operationId: getMetricsByModelCSV
      responses:
        '200':
          description: successful operation
          content:
            text/csv: {}
        '400':
          description: Invalid query string
        '404':
          description: Model not found
    parameters:
    - name: model
      in: path
      description: Metrics table name (e.g. site, organization, dataset)
      required: true
      schema:
        type: string
        example: site
    - name: column__sort
      in: query
      required: false
      description: Sort by column (column__sort=asc or column__sort=desc)
      schema:
        type: string
        enum: [asc, desc]
    - name: column__exact
      in: query
      required: false
      description: Exact match (column__exact=value)
      schema:
        type: string
    - name: column__contains
      in: query
      required: false
      description: Substring match (column__contains=value)
      schema:
        type: string
    - name: column__less
      in: query
      required: false
      description: Less than (column__less=value)
      schema:
        type: string
    - name: column__greater
      in: query
      required: false
      description: Greater than (column__greater=value)
      schema:
        type: string
  /health/:
    get:
      tags:
        - Health
      description: Service health check (status, version, uptime).
      summary: Health check
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Health'
        '503':
          description: Database unavailable
components:
  schemas:
    Health:
      description: Health check response
      type: object
      properties:
        status:
          type: string
          example: ok
        version:
          type: string
          description: Deployed app version
        uptime_seconds:
          type: number
          description: Seconds since app startup
